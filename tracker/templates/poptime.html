{% extends "base.html" %}
{% block pagetitle %}Estimate Time{% endblock %}
{% block extra_js %}{% endblock %}
{##}
{#{% block breadcrumb %}#}
{#    <div class="breadcrumb">#}
{#        	<div class="wrap">#}
{#            	<div class="container">#}
{#                    <a href="/">Home</a> / <a href="/contact"> Contact</a><span>/</span>Thank you#}
{#            </div>#}
{#            </div>#}
{#        </div>#}
{#{% endblock %}#}

{% block main_content %}
    <div class="wrap">
        	<div class="container">
                <section>
                    <div class="row">
                        <div class="span8">
                            <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
                            <script type="application/javascript">
                                function getURLParameter(name) {
                                      return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
                                    }

                                var userlat = getURLParameter('userlat').trim();
                                var userlong = getURLParameter('userlong').trim();
                                var buslat = getURLParameter('buslat').trim();
                                var buslong = getURLParameter('buslong').trim();
{#                                alert(userlat);#}
                                var map;
                                var geocoder;
                                var bounds = new google.maps.LatLngBounds();
                                var markersArray = [];

                                var origin1 = new google.maps.LatLng(userlat, userlong);
                                var destinationB = new google.maps.LatLng(buslat, buslong);
{#                                var origin1 = new google.maps.LatLng(0.331612, 32.573512);#}
{#                                var destinationB = new google.maps.LatLng(0.355471, 32.613321);#}

                                var destinationIcon = 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=D|FF0000|000000';
                                var originIcon = 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=O|FFFF00|000000';

                                function initialize() {
                                  var opts = {
                                    center: new google.maps.LatLng(0.332335, 32.579842),
                                    zoom: 10
                                  };
                                  map = new google.maps.Map(document.getElementById('map-canvas'), opts);
                                  geocoder = new google.maps.Geocoder();
                                }

                                function calculateDistances() {
                                  var service = new google.maps.DistanceMatrixService();
                                  service.getDistanceMatrix(
                                    {
                                      origins: [origin1],
                                      destinations: [destinationB],
                                      travelMode: google.maps.TravelMode.DRIVING,
                                      unitSystem: google.maps.UnitSystem.METRIC,
                                      avoidHighways: false,
                                      avoidTolls: false
                                    }, callback);
                                }

                                function callback(response, status) {
                                  if (status != google.maps.DistanceMatrixStatus.OK) {
                                    alert('Error was: ' + status);
                                  } else {
                                    var origins = response.originAddresses;
                                    var destinations = response.destinationAddresses;
                                    var outputDiv = document.getElementById('outputDiv');
                                    outputDiv.innerHTML = '';
                                    deleteOverlays();

                                    for (var i = 0; i < origins.length; i++) {
                                      var results = response.rows[i].elements;
                                      addMarker(origins[i], false);
                                      for (var j = 0; j < results.length; j++) {
                                        addMarker(destinations[j], true);
                                        outputDiv.innerHTML += origins[i] + ' to ' + destinations[j]
                                            + ': ' + results[j].distance.text + ' in '
                                            + results[j].duration.text + '<br>';
                                      }
                                    }
                                  }
                                }

                                function addMarker(location, isDestination) {
                                  var icon;
                                  if (isDestination) {
                                    icon = destinationIcon;
                                  } else {
                                    icon = originIcon;
                                  }
                                  geocoder.geocode({'address': location}, function(results, status) {
                                    if (status == google.maps.GeocoderStatus.OK) {
                                      bounds.extend(results[0].geometry.location);
                                      map.fitBounds(bounds);
                                      var marker = new google.maps.Marker({
                                        map: map,
                                        position: results[0].geometry.location,
                                        icon: icon
                                      });
                                      markersArray.push(marker);
                                    } else {
                                      alert('Geocode was not successful for the following reason: '
                                        + status);
                                    }
                                  });
                                }

                                function deleteOverlays() {
                                  for (var i = 0; i < markersArray.length; i++) {
                                    markersArray[i].setMap(null);
                                  }
                                  markersArray = [];
                                }

                                google.maps.event.addDomListener(window, 'load', initialize);

                                $(function() {
                                    calculateDistances();
                                });

                            </script>

                             <div id="map-canvas" style="width: 100%; height: 500px"> </div>

                        </div>

                        <div class="span3">
                            <h2 class="title"><span>Get Time</span></h2>
                            <pre>
                                  Click the button to get an  estimate of how long it will take for a bus to get to you!
                            </pre>
                            <p><button type="button" onclick="calculateDistances();">Calculate distances</button></p>
                            <div id="outputDiv"></div>

                        </div>

                    </div>


                </section>

            </div>
        </div>
{% endblock %}
