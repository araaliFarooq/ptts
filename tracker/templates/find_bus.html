{% extends "base.html" %}
{% block pagetitle %}Find a Bus{% endblock %}
{% csrf_token %}

{% block breadcrumb %}
    <div class="breadcrumb">
        	<div class="wrap">
            	<div class="container">
                    <a href="/">Home</a><span>/</span>Find Bus
            </div>
            </div>
        </div>
{% endblock %}

{% block main_content %}
    <div class="wrap">
        	<div class="container">
                <section>
                     <div class="row">
                        <div class="span7">
                            <h2 class="title"><span>Route Map</span></h2>
                            <script type="text/javascript"
                              src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvk8_p3RIwPi2QUgusiQuaw2nQ61OQvRM&sensor=true">
                            </script>


                              <script type="text/javascript">
                                var map;
                                var myLatlng;
                                var current_zoom = 12;


                              function GMloader(){

                              if (document.getElementById('map-canvas')){

                                // Coordinates to center the map
                                myLatlng = new google.maps.LatLng(0.332335, 32.579842);

                                // options for the map
                                var mapOptions = {
                                    zoom: current_zoom,
                                    center: myLatlng,
                                    mapTypeId: google.maps.MapTypeId.ROADMAP
                                };
                                // Draw the map
                                   map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);

{#                                  {% for location in locationdata %}#}
{#                                       var point = new google.maps.LatLng({{location.latitude}},{{location.longitude}});#}
{#                                       var marker = new google.maps.Marker({#}
{#                                           position: point,#}
{#                                           map: map,#}
{#                                           title: '{{ mark.name }}'#}
{#                                          });#}
{#                                         marker['infowindow']  = new google.maps.InfoWindow({#}
{#                                                 content: "<h1>{{location.imei}}</h1>"+#}
{#                                                          "<p> {{location.latitude}}<br />{{location.longitude}}</p>"#}
{#                                                         ,#}
{#                                                 maxWidth:230#}
{#                                                   });#}
{#                                       google.maps.event.addListener(marker, 'click', function() {#}
{#                                            this['infowindow'].open(map, this);#}
{#                                                });#}
{#                                         google.maps.event.addListener(marker, 'mouseover', function() {#}
{#                                            this['infowindow'].open(map, this);#}
{#                                                });#}
{#                                      {%  endfor %}#}
                                          {% for location in buslocations %}
                                       var point = new google.maps.LatLng({{location.latitude}},{{location.longitude}});
                                       var marker = new google.maps.Marker({
                                           position: point,
                                           map: map,
                                           title: '{{ mark.name }}'
                                          });
                                         marker['infowindow']  = new google.maps.InfoWindow({
                                                 content: "<h1>{{location.bus_id }}</h1>"+
                                                          "<p> {{location.latitude}}<br />{{location.longitude}}</p>"
                                                         ,
                                                 maxWidth:230
                                                   });
                                       google.maps.event.addListener(marker, 'click', function() {
                                            this['infowindow'].open(map, this);
                                                });
                                         google.maps.event.addListener(marker, 'mouseover', function() {
                                            this['infowindow'].open(map, this);
                                                });
                                      {%  endfor %}

                                }
                             }
                             </script>

                                <script type="text/javascript">
                                    $(document).ready(function(){
                                        $("#getRoute").change(function(){
                                            var Rid=$(this).val();

                                             $("#check").html('<img src="static/img/loader.gif" align="absmiddle">&nbsp;Loading bus data...');

                                            $('#printHere').html(Rid);
                                            document.getElementById("admDivCheck").style.display = "block";


                                              function getCookie(name) {
                                                var cookieValue = null;
                                                if (document.cookie && document.cookie != '') {
                                                    var cookies = document.cookie.split(';');
                                                    for (var i = 0; i < cookies.length; i++) {
                                                        var cookie = jQuery.trim(cookies[i]);
                                                        // Does this cookie string begin with the name we want?
                                                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                                            break;
                                                        }
                                                    }
                                                }
                                                return cookieValue;
                                            }

                                               $.ajax
                                                ({
                                                type: "GET",
                                                url: "/getbuslocations/"+Rid,
                                                data: {'format':'json',csrfmiddlewaretoken: getCookie('csrftoken')},
                                                contentType: 'application/json',
                                                cache: false,
                                                success: function(html)
                                                {
                                                    alert("Response "+JSON.stringify(html));
                                                    var arr = html;
                                                    i;
                                                    for (i = 0; i < arr.length; ++i) {
                                                        console.log(arr[i].bus_id);
                                                        var point = new google.maps.LatLng(arr[i].latitude,arr[i].longitude);
                                                    var marker = new google.maps.Marker({
                                                    position: point,
                                                    map: map,
                                                    title: arr[i].bus_id
                                                    });
                                                    marker['infowindow']  = new google.maps.InfoWindow({
                                                    content: "<h1>"+arr[i].bus_id+"</h1>"+
                                                          "<p>"+ arr[i].latitude+"<br />"+arr[i].longitude+"</p>"
                                                         ,
                                                    maxWidth:230
                                                    });
                                                    google.maps.event.addListener(marker, 'click', function() {
                                                    this['infowindow'].open(map, this);
                                                    });
                                                    google.maps.event.addListener(marker, 'mouseover', function() {
                                                    this['infowindow'].open(map, this);
                                                    });
                                                        } //end forloop
                                                $(".busdata").html(JSON.stringify(html));
                                                $("#check").html(' ');
                                                },
                                                    error: function(xhr, textStatus, thrownError){
                                                        alert("xhr status: " + xhr.statusText);
                                                    }
                                                });
                                             return false;


                                        });
                                    });
                            </script>

                            <div id="map-canvas" style="width: 100%; height: 300px"> </div>

                        </div>

                        <div class="span4">
                            <h2 class="title"><span>Choose Route</span></h2>
                        	<p>

									<select id="getRoute" name="route">
											<option value="route"> Select Route </option>
											{% for route in routes %}
											<option id="route_id" value="{{route.id }}">{{ route.route_name }}</option>
											 {%  endfor %}
									</select>

							</p>
                        <p>
                            Ajax loaded data
                            <h3 name="busdata">replace with json data</h3>

                        </p>
                        <span id='check'></span>


                        </div>
                        <div id="admDivCheck" class="span4" style="display:block;">
                               <h4>STOPS</h4>
                                Route selected <span id="printHere"></span>

                        {% for route_stop in stops %}
                          <tr>
                            <td>{{ route_stop.id }}</td>
                            <td>{{ route_stop.stop_name }}</td>
                          </tr>
                        {% endfor %}

                        </div>
                    </div>
                </section>
            </div>
        </div>
{% endblock %}